name: Daily AI News Research

on:
  schedule:
    # Run daily at 6:00 AM UTC - adjust as needed for your timezone
    # For Europe/Dublin (UTC+0/+1), 6 AM local â‰ˆ 6 AM UTC (winter) or 5 AM UTC (summer)
    - cron: '0 6 * * *'
  workflow_dispatch:
    # Allow manual trigger from GitHub UI

jobs:
  research:
    runs-on: ubuntu-latest
    timeout-minutes: 60  # Agent can take a while to complete

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'

      - name: Install Python dependencies
        run: pip install -r requirements.txt

      - name: Install Playwright browsers
        run: playwright install --with-deps chromium

      - name: Create credentials directory
        run: mkdir -p credentials

      - name: Set up credentials
        env:
          CREDENTIALS_JSON: ${{ secrets.CREDENTIALS_JSON }}
          DRIVE_TOKEN_JSON: ${{ secrets.DRIVE_TOKEN_JSON }}
          GMAIL_TOKEN_JSON: ${{ secrets.GMAIL_TOKEN_JSON }}
        run: |
          echo "$CREDENTIALS_JSON" | base64 -d > credentials/credentials.json
          echo "$DRIVE_TOKEN_JSON" | base64 -d > credentials/drive_token.json
          echo "$GMAIL_TOKEN_JSON" | base64 -d > credentials/gmail_token.json

      - name: Create .env file
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          GCP_SERVICES_API_KEY: ${{ secrets.GCP_SERVICES_API_KEY }}
          GOOGLE_DRIVE_FOLDER_ID: ${{ secrets.GOOGLE_DRIVE_FOLDER_ID }}
          RECIPIENT_EMAIL: ${{ secrets.RECIPIENT_EMAIL }}
        run: |
          cat << EOF > .env
          GOOGLE_GENAI_USE_VERTEXAI=FALSE
          GEMINI_API_KEY=$GEMINI_API_KEY
          OPENAI_API_KEY=$OPENAI_API_KEY
          GCP_SERVICES_API_KEY=$GCP_SERVICES_API_KEY
          GOOGLE_DRIVE_FOLDER_ID=$GOOGLE_DRIVE_FOLDER_ID
          RECIPIENT_EMAIL=$RECIPIENT_EMAIL
          EOF

      - name: Create required directories
        run: |
          mkdir -p research_history
          mkdir -p agent_notes

      - name: Run research agent with token monitoring
        run: |
          # Start background process to print token usage every minute
          (
            while true; do
              sleep 60
              if [ -f "research_history/current_token_usage.json" ]; then
                echo "=== Token Usage ($(date '+%H:%M:%S')) ==="
                cat research_history/current_token_usage.json | python3 -m json.tool 2>/dev/null || cat research_history/current_token_usage.json
                echo "================================"
              fi
            done
          ) &
          MONITOR_PID=$!

          # Run the agent
          python3 app.py --now
          EXIT_CODE=$?

          # Stop the monitoring process
          kill $MONITOR_PID 2>/dev/null || true

          # Print final token usage
          echo "=== Final Token Usage ==="
          if [ -f "research_history/current_token_usage.json" ]; then
            cat research_history/current_token_usage.json | python3 -m json.tool 2>/dev/null || echo "File was cleared (run completed)"
          else
            echo "Token usage file not found (run completed)"
          fi

          exit $EXIT_CODE
